(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{1251:function(e,t,n){"use strict";n.r(t);var r=n(38),a=n.n(r),o=n(40),i=n.n(o),s=n(44),l=n.n(s),c=n(51),u=n(364),h=n(41),p=n(39);t.default=l()({displayName:"ImportE2eKeysDialog",propTypes:{matrixClient:i.a.instanceOf(c.i).isRequired,onFinished:i.a.func.isRequired},getInitialState:function(){return{enableSubmit:!1,phase:1,errStr:null}},UNSAFE_componentWillMount:function(){this._unmounted=!1,this._file=Object(r.createRef)(),this._passphrase=Object(r.createRef)()},componentWillUnmount:function(){this._unmounted=!0},_onFormChange:function(e){const t=this._file.current.files||[];this.setState({enableSubmit:""!==this._passphrase.current.value&&t.length>0})},_onFormSubmit:function(e){return e.preventDefault(),this._startImport(this._file.current.files[0],this._passphrase.current.value),!1},_startImport:function(e,t){return this.setState({errStr:null,phase:2}),function(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=e=>{t(e.target.result)},r.onerror=n,r.readAsArrayBuffer(e)})}(e).then(e=>u.a(e,t)).then(e=>this.props.matrixClient.importRoomKeys(JSON.parse(e))).then(()=>{this.props.onFinished(!0)}).catch(e=>{if(console.error("Error importing e2e keys:",e),this._unmounted)return;const t=e.friendlyText||Object(p.a)("Unknown error");this.setState({errStr:t,phase:1})})},_onCancelClick:function(e){return e.preventDefault(),this.props.onFinished(!1),!1},render:function(){const e=h.getComponent("views.dialogs.BaseDialog"),t=1!==this.state.phase;return a.a.createElement(e,{className:"mx_importE2eKeysDialog",onFinished:this.props.onFinished,title:Object(p.a)("Import room keys")},a.a.createElement("form",{onSubmit:this._onFormSubmit},a.a.createElement("div",{className:"mx_Dialog_content"},a.a.createElement("p",null,Object(p.a)("This process allows you to import encryption keys that you had previously exported from another Matrix client. You will then be able to decrypt any messages that the other client could decrypt.")),a.a.createElement("p",null,Object(p.a)("The export file will be protected with a passphrase. You should enter the passphrase here, to decrypt the file.")),a.a.createElement("div",{className:"error"},this.state.errStr),a.a.createElement("div",{className:"mx_E2eKeysDialog_inputTable"},a.a.createElement("div",{className:"mx_E2eKeysDialog_inputRow"},a.a.createElement("div",{className:"mx_E2eKeysDialog_inputLabel"},a.a.createElement("label",{htmlFor:"importFile"},Object(p.a)("File to import"))),a.a.createElement("div",{className:"mx_E2eKeysDialog_inputCell"},a.a.createElement("input",{ref:this._file,id:"importFile",type:"file",autoFocus:!0,onChange:this._onFormChange,disabled:t}))),a.a.createElement("div",{className:"mx_E2eKeysDialog_inputRow"},a.a.createElement("div",{className:"mx_E2eKeysDialog_inputLabel"},a.a.createElement("label",{htmlFor:"passphrase"},Object(p.a)("Enter passphrase"))),a.a.createElement("div",{className:"mx_E2eKeysDialog_inputCell"},a.a.createElement("input",{ref:this._passphrase,id:"passphrase",size:"64",type:"password",onChange:this._onFormChange,disabled:t}))))),a.a.createElement("div",{className:"mx_Dialog_buttons"},a.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(p.a)("Import"),disabled:!this.state.enableSubmit||t}),a.a.createElement("button",{onClick:this._onCancelClick,disabled:t},Object(p.a)("Cancel")))))}})},364:function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return p}));var r=n(357),a=n(39),o=n(48);let i=window.TextEncoder;i||(i=r.TextEncoder);let s=window.TextDecoder;s||(s=r.TextDecoder);const l=window.crypto.subtle||window.crypto.webkitSubtle;function c(e,t){const n=new Error(e);return n.friendlyText=t,n}function u(){return Object(a.a)("Your browser does not support the required cryptography extensions")}async function h(e,t){const n=function(e){const t=(new s).decode(new Uint8Array(e));let n=0;for(;;){const e=t.indexOf("\n",n);if(e<0)throw new Error("Header line not found");const r=t.slice(n,e).trim();if(n=e+1,r===m)break}const r=n;for(;;){const e=t.indexOf("\n",n);if("-----END MEGOLM SESSION DATA-----"===t.slice(n,e<0?void 0:e).trim())break;if(e<0)throw new Error("Trailer line not found");n=e+1}const a=n;return function(e){const t=window.atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}(t.slice(r,a))}(e),r=o.a.get().brand;if(n.length<1)throw c("Invalid file: too short",Object(a.a)("Not a valid %(brand)s keyfile",{brand:r}));if(1!==n[0])throw c("Unsupported version",Object(a.a)("Not a valid %(brand)s keyfile",{brand:r}));const i=n.length-69;if(i<0)throw c("Invalid file: too short",Object(a.a)("Not a valid %(brand)s keyfile",{brand:r}));const h=n.subarray(1,17),p=n.subarray(17,33),y=n[33]<<24|n[34]<<16|n[35]<<8|n[36],f=n.subarray(37,37+i),w=n.subarray(-32),[b,E]=await d(h,y,t),g=n.subarray(0,-32);let _,C;try{_=await l.verify({name:"HMAC"},E,w,g)}catch(e){throw c("subtleCrypto.verify failed: "+e,u())}if(!_)throw c("hmac mismatch",Object(a.a)("Authentication check failed: incorrect password?"));try{C=await l.decrypt({name:"AES-CTR",counter:p,length:64},b,f)}catch(e){throw c("subtleCrypto.decrypt failed: "+e,u())}return(new s).decode(new Uint8Array(C))}async function p(e,t,n){const r=(n=n||{}).kdf_rounds||5e5,a=new Uint8Array(16);window.crypto.getRandomValues(a);const o=new Uint8Array(16);window.crypto.getRandomValues(o),o[8]&=127;const[s,h]=await d(a,r,t),p=(new i).encode(e);let f;try{f=await l.encrypt({name:"AES-CTR",counter:o,length:64},s,p)}catch(e){throw c("subtleCrypto.encrypt failed: "+e,u())}const w=new Uint8Array(f),b=1+a.length+o.length+4+w.length+32,E=new Uint8Array(b);let g=0;E[g++]=1,E.set(a,g),g+=a.length,E.set(o,g),g+=o.length,E[g++]=r>>24,E[g++]=r>>16&255,E[g++]=r>>8&255,E[g++]=255&r,E.set(w,g),g+=w.length;const _=E.subarray(0,g);let C;try{C=await l.sign({name:"HMAC"},h,_)}catch(e){throw c("subtleCrypto.sign failed: "+e,u())}const v=new Uint8Array(C);return E.set(v,g),function(e){const t=Math.ceil(e.length/96),n=new Array(t+3);n[0]=m;let r,a=0;for(r=1;r<=t;r++)n[r]=y(e.subarray(a,a+96)),a+=96;return n[r++]="-----END MEGOLM SESSION DATA-----",n[r]="",(new i).encode(n.join("\n")).buffer}(E)}async function d(e,t,n){const r=new Date;let a,o;try{a=await l.importKey("raw",(new i).encode(n),{name:"PBKDF2"},!1,["deriveBits"])}catch(e){throw c("subtleCrypto.importKey failed: "+e,u())}try{o=await l.deriveBits({name:"PBKDF2",salt:e,iterations:t,hash:"SHA-512"},a,512)}catch(e){throw c("subtleCrypto.deriveBits failed: "+e,u())}const s=new Date;console.log("E2e import/export: deriveKeys took "+(s-r)+"ms");const h=o.slice(0,32),p=o.slice(32),d=l.importKey("raw",h,{name:"AES-CTR"},!1,["encrypt","decrypt"]).catch(e=>{throw c("subtleCrypto.importKey failed for AES key: "+e,u())}),m=l.importKey("raw",p,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]).catch(e=>{throw c("subtleCrypto.importKey failed for HMAC key: "+e,u())});return await Promise.all([d,m])}const m="-----BEGIN MEGOLM SESSION DATA-----";function y(e){const t=String.fromCharCode.apply(null,e);return window.btoa(t)}}}]);
//# sourceMappingURL=21.js.map